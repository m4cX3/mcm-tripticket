<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Summary</title>
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_records_detailed.css') }}" type="text/css">
    <script>
        function denyRequest(username, travelStartDate, vehicleType, requestedBy) {
            var remarks = prompt("Enter remarks for denial:");
            if (remarks === null) {
                return; // User clicked "Cancel"
            }
            if (remarks.trim() === '') {
                alert('Please enter remarks.');
                return;
            }
        
            // Construct the URL with parameters
            const url = `/deny_request?start_date=${encodeURIComponent(travelStartDate)}&vehicle_type=${encodeURIComponent(vehicleType)}&requested_by=${encodeURIComponent(requestedBy)}`;
        
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'username': username,
                    'remarks': remarks,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Request has been Denied');
                    window.location.href = '/admin_records?username=' + username;  // Redirect to requests page after denying
                } else {
                    alert('Error denying request');
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Extract URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const startDate = urlParams.get('start_date');
            const vehicleType = urlParams.get('vehicle_type');
            const requestedBy = urlParams.get('requested_by');
            
            console.log(startDate, vehicleType, requestedBy); // Debugging to check values
            
            return { startDate, vehicleType, requestedBy };
        }

        // Event handler for the deny button
        function onDenyButtonClick(username) {
            const { startDate, vehicleType, requestedBy } = getUrlParams();
            denyRequest(username, startDate, vehicleType, requestedBy);
        }

        function approveRequest(username, travelStartDate, vehicleType, requestedBy) {
            // Construct the URL with parameters
            const url = `/approve_request?start_date=${encodeURIComponent(travelStartDate)}&vehicle_type=${encodeURIComponent(vehicleType)}&requested_by=${encodeURIComponent(requestedBy)}`;
        
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'username': username
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Request has been Approved');
                    window.location.href = '/admin_records?username=' + username;  // Redirect to requests page after approval
                } else {
                    alert('Error approving request: ' + data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Event handler for the approve button
        function onApproveButtonClick(username) {
            const { startDate, vehicleType, requestedBy } = getUrlParams();
            approveRequest(username, startDate, vehicleType, requestedBy);
        }
        
    </script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="badge-logo">
            <img id="mcm" src="{{ url_for('static', filename='images/mmcm small logo.png') }}" alt="MMCM Logo">
        </div>
        <a href='{{ url_for('admin_dashboard_page', username=username) }}'>Dashboard</a>
        <a href='{{ url_for('admin_requests_page', username=username) }}'>Requests</a>
        <a href='{{ url_for('admin_records_page', username=username) }}'>Records</a>
        <a href='{{ url_for('admin_vehicles_page', username=username) }}'>Vehicles</a>
        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <a href='{{ url_for('login_page') }}'>Log Out</a>
    </div>

    <!-- Main content -->
    <div class="main-content">
        {% if details[0]['Approval'] == 0 and details[0]['Remarks'] is none %}
        <h3>This is a pending request</h3>
        {% endif %}
        {% if details[0]['Approval'] == 0 and details[0]['Remarks'] is not none %}
        <h3>Request has been denied</h3>
        {% endif %}
        {% if details[0]['Approval'] == 1 %}
        <h3>Request has been accepted</h3>
        {% endif %}
        <!-- Summary box -->
        <div class="summary-box">
            <ul>
                <li><strong>Date Filled:</strong> {{ details[0]['DateFilled'] }}</li>
                <li><strong>Requested By:</strong> {{ details[0]['RequestedBy'] }}</li>
                <li><strong>Department:</strong> {{ details[0]['Department'] }} </li>
                <li><strong>Purpose of Trip:</strong> {{ details[0]['Purpose_Of_Trip'] }}</li>
                <li><strong>Vehicle Type:</strong> {{ details[0]['VehicleType'] }}</li>
                <br>
                <li><strong>Vehicle Name:</strong> {{ details[0]['VehicleName'] }}</li>
                <li><strong>Vehicle Classification:</strong> {{ details[0]['Classification'] }}</li>
                <li><strong>Vehicle Seating Capcity:</strong> {{ details[0]['SeatingCapacity'] }}</li>
                <li><strong>Vehicle Plate Number:</strong> {{ details[0]['PlateNumber'] }}</li>
                {% if details[0]['Remarks'] is not none %}
                <br><br>
                <li><strong>Remarks for Denial: </strong> {{ details[0]['Remarks']}}</li>
                {% endif %}
            </ul>
        </div>
        <div class="details-box">
            <h3 style="color: white">Travel Details:</h3>
            <table>
                <tr>
                    <th>Start Date</th>
                    <th>Start Time</th>
                    <th>Estimated Return</th>
                    <th>Destinations</th>
                </tr>
                {% for travel in details %}
                    <tr>
                        <td>{{ travel.StartDate }}</td>
                        <td>{{ travel.StartTime }}</td>
                        <td>{{ travel.EstimatedReturns }}</td>
                        <td>{{ travel.Destinations }}</td>
                    </tr>
                {% endfor %}
            </table>
        </div>
        {% if details[0]['Approval'] == 0 and details[0]['Remarks'] is none %}
        <div class="button-container">
            <input type="button" id="deny" name="deny" value="Deny" class="deny-button" onclick="onDenyButtonClick('{{ username }}')">
            <input type="button" id="approve" name="approve" value="Approve" class="approve-button" onclick="onApproveButtonClick('{{ username }}')">
        </div>
        {% endif %}
    </div>
</body>
</html>